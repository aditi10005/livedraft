<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>liveDraft</title>
    <link rel="stylesheet" href="css/normalize.css">
    <link rel="stylesheet" href="css/skeleton.css">
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="node_modules/tingle.js/src/tingle.css">

    <script src="node_modules/tingle.js/src/tingle.js"></script>
    <script type="text/javascript" src="js/jquery.js"></script>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
    <script src="https://cdn.pubnub.com/sdk/javascript/pubnub.4.20.2.js"></script>

  </head>
  <body>
    <div id="header"><p id="title">liveDraft</p></div>
    <div id="sidemenu">
      <button class="button-primary small_btn color_red" id="share_btn" onclick="startSharing()" >SHARE</button>
      <button class="small_btn" onclick="tryJoining()" id="join_btn" >JOIN</button>
      <div id="users_list">
          <p> ONLINE</p>
      </div>
    </div>
    <input id="cursor" style="display:none"></input>
    <div id="container">
      <textarea id="main_writer" class="medium_font" placeholder="Start typing..."></textarea>
    </div>

    <script type="text/javascript" src="js/joinModal.js"></script>
    <script type="text/javascript" src="js/shareModal.js"></script>
    <script>
      require('./renderer.js')
      var channel = "11-884-34";//Math.floor(Math.random() * 20)+"-"+Math.floor(Math.random() * 1000)+"-"+Math.floor(Math.random() * 100);
      var body = $("#main_writer").val();
      var sharing = false;
      var typing = false;
      var name = "AL";
      var cursorPosition = 0;
      var userId = 1;
      var pubnub = new PubNub({
          publishKey : 'pub-c-4c8b4681-1768-4bd1-b251-964e22884f07',
          subscribeKey : 'sub-c-d487f296-2515-11e8-9bf4-060db84035e6'
      })
      var message = {}
    
      function startSharing() {
        body = $("#main_writer").val();
        message.body = body;
        message.type = "doc_sharing";
        message.id = userId;
        message.name = name;
        publish();
        //hide share button
      }
      
      function tryJoining() {
        $("#main_writer").val("");
        sharing = true;
        modal.open();
      }

      $("#main_writer").keydown(function(){
          typing = true;
      });

      $("#main_writer").keyup(function() {
          body = $("#main_writer").val();
          typing = false;
          var cursorPosition =  $('#main_writer').prop("selectionStart");
          //$("#main_writer")[0].setSelectionRange(cursorPosition, cursorPosition);
          $("#cursor").val(cursorPosition);
          if (sharing == true) {
            //keep publishing
            publishMessage();
          }
      });

      function publishMessage() {
            body = $("#main_writer").val();
            message.type = "doc_sharing";
            message.id = userId;
            message.name = name;
            message.body = body;
            message.len = body.length;
            message.cur = $("#cursor").val();
            var publishConfig = {
                channel : channel,
                message : message
            }
            //console.log(channel);
            pubnub.publish(publishConfig, function(status, response) {
                //console.log(status, response);
      })}

      function join() {
          channel = $("#join_code").val();
          name = $("#join_name").val();
          connect();
          //fetch data from other peer's working copy
          fetchCopy();
      }

      function share() {
          name = $("#share_name").val();
      }

      function fetchCopy() {
            body = $("#main_writer").val();
            message.type = "fetch_doc";
            message.id = userId;
            message.name = name;
            var publishConfig = {
                channel : channel,
                message : message
            }
            pubnub.publish(publishConfig, function(status, response) {
                //console.log(status, response);
      })}
      
      //-----Setup Publishing
      function connect() {
        sharing = true;
        pubnub.addListener({
            status: function(statusEvent) {
                if (statusEvent.category === "PNConnectedCategory") {
                    publishMessage();
                }
            },
            message: function(message) {
                if (typing == false) {
                if (message.message.id == userId) {
                } 
                else {

                    var type = message.message.type;
                    if (type == "fetch_doc") {
                        publishMessage();
                    }
                    else if (type == "doc_sharing"){
                        //update the body
                        var cur = message.message.cur;
                        var len = message.message.len;
                        cursorPosition = parseInt($("#cursor").val());
                        var currBody = $("#main_writer").val();
                        $("#main_writer").val(message.message.body);
                        
                        if (cur <= cursorPosition) {
                            //other user typed above the current user's text
                            console.log("in above");
                            var offset = len - currBody.length;
                            console.log(len+" "+currBody.length);
                            console.log(cursorPosition+offset);
                            $("#main_writer")[0].setSelectionRange(cursorPosition+offset,cursorPosition+offset);
                            $("#cursor").val(cursorPosition+offset);
                        }
                        else {
                            $("#main_writer")[0].setSelectionRange($("#cursor").val(), $("#cursor").val());
                        }
                        
                    }
                }
            }},
            presence: function(presenceEvent) {
                // handle presence
            }
        })      
        console.log("Subscribing..");
        pubnub.subscribe({
            channels: [channel] 
        });
      };
    </script>
  </body>
</html>
